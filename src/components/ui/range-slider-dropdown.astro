---
/**
 * RangeSliderDropdown - Dual-range slider with quick picks for filtering
 *
 * @example
 * <RangeSliderDropdown type="price" name="price-filter" />
 * <RangeSliderDropdown type="area" placeholder="Chọn diện tích" />
 * <RangeSliderDropdown type="custom" formatFn={(v) => `${v} units`} min={0} max={100} />
 *
 * @prop type - 'price' | 'area' | 'custom' determines formatting and defaults
 * @prop id - Form input ID (optional)
 * @prop name - Form input name (optional)
 * @prop placeholder - Trigger button text (optional, uses type default)
 * @prop quickPicks - Custom quick pick options (optional)
 * @prop min - Minimum range value (optional)
 * @prop max - Maximum range value (optional)
 * @prop step - Slider step increment (optional)
 * @prop formatFn - Custom formatter function for 'custom' type (optional)
 */

interface QuickPick {
  label: string;
  min: number;
  max: number;
}

type FormatFn = (value: number) => string;

interface Props {
  type: "price" | "area" | "custom";
  id?: string;
  name?: string;
  placeholder?: string;
  quickPicks?: QuickPick[];
  min?: number;
  max?: number;
  step?: number;
  formatFn?: FormatFn;
}

const DEFAULTS = {
  price: {
    min: 0,
    max: 60000,
    step: 100,
    placeholder: "Khoảng giá",
    title: "Khoảng giá",
    quickPicks: [
      { label: "Dưới 500 triệu", min: 0, max: 500 },
      { label: "500 triệu - 1 tỷ", min: 500, max: 1000 },
      { label: "800 triệu - 1 tỷ", min: 800, max: 1000 },
      { label: "1 tỷ - 2 tỷ", min: 1000, max: 2000 },
      { label: "2 tỷ - 3 tỷ", min: 2000, max: 3000 },
      { label: "3 tỷ - 5 tỷ", min: 3000, max: 5000 },
      { label: "5 tỷ - 7 tỷ", min: 5000, max: 7000 },
      { label: "7 tỷ - 10 tỷ", min: 7000, max: 10000 },
      { label: "10 tỷ - 20 tỷ", min: 10000, max: 20000 },
      { label: "20 tỷ - 60 tỷ", min: 20000, max: 60000 },
    ],
  },
  area: {
    min: 0,
    max: 1000,
    step: 5,
    placeholder: "Diện tích",
    title: "Diện tích",
    quickPicks: [
      { label: "Dưới 30 m²", min: 0, max: 30 },
      { label: "30 - 50 m²", min: 30, max: 50 },
      { label: "50 - 80 m²", min: 50, max: 80 },
      { label: "80 - 100 m²", min: 80, max: 100 },
      { label: "100 - 150 m²", min: 100, max: 150 },
      { label: "150 - 200 m²", min: 150, max: 200 },
      { label: "200 - 300 m²", min: 200, max: 300 },
      { label: "300 - 500 m²", min: 300, max: 500 },
      { label: "Trên 500 m²", min: 500, max: 1000 },
    ],
  },
  custom: {
    min: 0,
    max: 100,
    step: 1,
    placeholder: "Select range",
    title: "Range",
    quickPicks: [],
  },
};

const { type, id, name, placeholder, quickPicks, min, max, step } = Astro.props;

const config = DEFAULTS[type] || DEFAULTS.custom;
const finalMin = min ?? config.min;
const finalMax = max ?? config.max;
const finalStep = step ?? config.step;
const finalPlaceholder = placeholder ?? config.placeholder;
const finalQuickPicks = quickPicks ?? config.quickPicks;
const finalTitle = config.title;
const finalId = id ?? `${type}-range`;
const finalName = name ?? type;
---

<div class="range-dropdown relative flex-1" data-range-dropdown data-type={type}>
  <!-- Trigger Button -->
  <button
    type="button"
    class="w-full px-3 py-2.5 border border-secondary-200 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-primary-500 text-secondary-600 text-sm text-left flex items-center justify-between"
    data-trigger
  >
    <span data-display>{finalPlaceholder}</span>
    <svg
      class="w-4 h-4 text-secondary-400 transition-transform"
      data-arrow
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Hidden input for form submission -->
  <input type="hidden" name={finalName} id={finalId} data-input />

  <!-- Dropdown Panel -->
  <div
    class="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-white rounded-xl shadow-2xl border border-secondary-100 p-4 z-50 w-full hidden"
    data-panel
  >
    <h4 class="text-lg font-bold text-secondary-800 text-center mb-3">{finalTitle}</h4>

    <!-- Range Display -->
    <div class="flex justify-between mb-3 text-sm">
      <span class="text-secondary-600">
        từ <span class="text-primary-500 font-semibold" data-min-display></span>
      </span>
      <span class="text-secondary-600">
        đến <span class="text-primary-500 font-semibold" data-max-display></span>
      </span>
    </div>

    <!-- Input Fields -->
    <div class="grid grid-cols-2 gap-2 mb-3">
      <input
        type="number"
        class="w-full px-2 py-1.5 border border-secondary-200 rounded-lg text-center text-sm text-secondary-700 focus:outline-none focus:ring-1 focus:ring-primary-500"
        data-min-input
      />
      <input
        type="number"
        class="w-full px-2 py-1.5 border border-secondary-200 rounded-lg text-center text-sm text-secondary-700 focus:outline-none focus:ring-1 focus:ring-primary-500"
        data-max-input
      />
    </div>

    <!-- Dual Range Slider -->
    <div class="relative h-6 mb-4 flex items-center" data-slider-container>
      <div class="absolute left-0 right-0 h-2 bg-secondary-200 rounded-full"></div>
      <div class="absolute h-2 bg-primary-500 rounded-full" data-track></div>
      <div
        class="absolute w-5 h-5 bg-primary-500 rounded-full border-2 border-white shadow-md cursor-grab active:cursor-grabbing z-20"
        data-thumb-min
      ></div>
      <div
        class="absolute w-5 h-5 bg-primary-500 rounded-full border-2 border-white shadow-md cursor-grab active:cursor-grabbing z-20"
        data-thumb-max
      ></div>
    </div>

    <!-- Quick Picks -->
    {finalQuickPicks.length > 0 && (
      <div class="max-h-40 overflow-y-auto space-y-0.5 mb-3">
        {finalQuickPicks.map((pick) => (
          <button
            type="button"
            class="quick-pick w-full flex items-center justify-between px-2 py-1.5 rounded-lg hover:bg-secondary-50 transition-colors text-secondary-700 text-sm"
            data-min={pick.min}
            data-max={pick.max}
          >
            <span>{pick.label}</span>
            <div class="w-4 h-4 rounded-full border-2 border-secondary-300 flex items-center justify-center">
              <svg class="w-2.5 h-2.5 text-white hidden" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
          </button>
        ))}
      </div>
    )}

    <!-- Reset Button -->
    <button
      type="button"
      class="px-4 py-1.5 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition-colors font-medium"
      data-reset
    >
      Đặt lại
    </button>
  </div>
</div>

<script
  define:vars={{
    configMin: finalMin,
    configMax: finalMax,
    configStep: finalStep,
    configPlaceholder: finalPlaceholder,
    configType: type,
  }}
>
  // Initialize each range dropdown
  document.querySelectorAll("[data-range-dropdown]").forEach((dropdown) => {
    // Skip if already initialized
    if (dropdown.dataset.initialized) return;
    dropdown.dataset.initialized = "true";

    const type = dropdown.dataset.type;
    const trigger = dropdown.querySelector("[data-trigger]");
    const panel = dropdown.querySelector("[data-panel]");
    const arrow = dropdown.querySelector("[data-arrow]");
    const display = dropdown.querySelector("[data-display]");
    const input = dropdown.querySelector("[data-input]");

    const minInput = dropdown.querySelector("[data-min-input]");
    const maxInput = dropdown.querySelector("[data-max-input]");
    const minDisplay = dropdown.querySelector("[data-min-display]");
    const maxDisplay = dropdown.querySelector("[data-max-display]");

    const sliderContainer = dropdown.querySelector("[data-slider-container]");
    const track = dropdown.querySelector("[data-track]");
    const thumbMin = dropdown.querySelector("[data-thumb-min]");
    const thumbMax = dropdown.querySelector("[data-thumb-max]");

    const resetBtn = dropdown.querySelector("[data-reset]");
    const quickPicks = dropdown.querySelectorAll(".quick-pick");

    // Type-specific configurations
    const configs = {
      price: { min: 0, max: 60000, step: 100, placeholder: "Khoảng giá" },
      area: { min: 0, max: 1000, step: 5, placeholder: "Diện tích" },
      custom: { min: 0, max: 100, step: 1, placeholder: "Select range" },
    };

    const config = configs[type] || configs.custom;
    const MIN = config.min;
    const MAX = config.max;
    const STEP = config.step;
    const PLACEHOLDER = config.placeholder;

    let minVal = MIN;
    let maxVal = MAX;

    // Format functions for different types
    function formatPrice(value) {
      if (value === 0) return "0 triệu";
      if (value >= 1000) return `${value / 1000} tỷ`;
      return `${value} triệu`;
    }

    function formatArea(value) {
      return `${value} m²`;
    }

    function formatValue(value) {
      if (type === "price") return formatPrice(value);
      if (type === "area") return formatArea(value);
      return String(value);
    }

    function updateUI() {
      minDisplay.textContent = formatValue(minVal);
      maxDisplay.textContent = formatValue(maxVal);

      // Only update input if value changed to avoid cursor jump
      if (minInput.value !== String(minVal)) minInput.value = String(minVal);
      if (maxInput.value !== String(maxVal)) maxInput.value = String(maxVal);

      const minPercent = (minVal / MAX) * 100;
      const maxPercent = (maxVal / MAX) * 100;
      track.style.left = `${minPercent}%`;
      track.style.right = `${100 - maxPercent}%`;
      thumbMin.style.left = `calc(${minPercent}% - 10px)`;
      thumbMax.style.left = `calc(${maxPercent}% - 10px)`;

      if (minVal === MIN && maxVal === MAX) {
        input.value = "";
        display.textContent = PLACEHOLDER;
      } else {
        input.value = `${minVal}-${maxVal}`;
        display.textContent = `${formatValue(minVal)} - ${formatValue(maxVal)}`;
      }

      quickPicks.forEach((btn) => {
        const pickMin = Number(btn.dataset.min);
        const pickMax = Number(btn.dataset.max);
        const isActive = minVal === pickMin && maxVal === pickMax;
        const circle = btn.querySelector("div");
        const check = btn.querySelector("svg");
        if (isActive) {
          btn.classList.add("bg-primary-50", "text-primary-600");
          btn.classList.remove("text-secondary-700");
          circle.classList.add("border-primary-500", "bg-primary-500");
          circle.classList.remove("border-secondary-300");
          check.classList.remove("hidden");
        } else {
          btn.classList.remove("bg-primary-50", "text-primary-600");
          btn.classList.add("text-secondary-700");
          circle.classList.remove("border-primary-500", "bg-primary-500");
          circle.classList.add("border-secondary-300");
          check.classList.add("hidden");
        }
      });
    }

    // Drag functionality for thumbs
    function setupDrag(thumb, isMin) {
      let isDragging = false;

      const onMove = (clientX) => {
        if (!isDragging) return;
        const rect = sliderContainer.getBoundingClientRect();
        const percent = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
        const value = Math.round(((percent / 100) * MAX) / STEP) * STEP;

        if (isMin) {
          minVal = Math.min(value, maxVal - STEP);
        } else {
          maxVal = Math.max(value, minVal + STEP);
        }
        updateUI();
      };

      thumb.addEventListener("mousedown", (e) => {
        isDragging = true;
        e.preventDefault();
      });

      thumb.addEventListener("touchstart", (e) => {
        isDragging = true;
        e.preventDefault();
      });

      document.addEventListener("mousemove", (e) => onMove(e.clientX));
      document.addEventListener("touchmove", (e) => onMove(e.touches[0].clientX));

      document.addEventListener("mouseup", () => {
        isDragging = false;
      });
      document.addEventListener("touchend", () => {
        isDragging = false;
      });
    }

    setupDrag(thumbMin, true);
    setupDrag(thumbMax, false);

    // Toggle dropdown
    trigger.addEventListener("click", () => {
      panel.classList.toggle("hidden");
      arrow.classList.toggle("rotate-180");
    });

    // Close on outside click
    document.addEventListener("click", (e) => {
      if (!dropdown.contains(e.target)) {
        panel.classList.add("hidden");
        arrow.classList.remove("rotate-180");
      }
    });

    // Input changes - use both 'input' for real-time and 'change' for validation
    const handleMinInput = () => {
      const val = Number(minInput.value) || 0;
      minVal = Math.max(MIN, Math.min(val, maxVal - STEP));
      updateUI();
    };

    const handleMaxInput = () => {
      const val = Number(maxInput.value) || MAX;
      maxVal = Math.min(MAX, Math.max(val, minVal + STEP));
      updateUI();
    };

    minInput.addEventListener("input", handleMinInput);
    minInput.addEventListener("change", handleMinInput);
    maxInput.addEventListener("input", handleMaxInput);
    maxInput.addEventListener("change", handleMaxInput);

    // Quick picks
    quickPicks.forEach((btn) => {
      btn.addEventListener("click", () => {
        minVal = Number(btn.dataset.min);
        maxVal = Number(btn.dataset.max);
        updateUI();
      });
    });

    // Reset
    resetBtn.addEventListener("click", () => {
      minVal = MIN;
      maxVal = MAX;
      updateUI();
    });

    updateUI();
  });
</script>
