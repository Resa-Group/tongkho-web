# System Architecture

## High-Level Overview

```
┌─────────────────────────────────────────────────────────┐
│                    TONGKHO-WEB ARCHITECTURE              │
└─────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│                      BROWSER (User)                          │
│  (Zero JavaScript - Static HTML only)                        │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                   STATIC HTML/CSS OUTPUT                      │
│  (Generated by Astro at build time)                          │
│  - Homepage (index.html)                                     │
│  - Sitemap (sitemap.xml)                                     │
│  - Assets (CSS, images, fonts)                               │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                    STATIC FILE SERVER                         │
│  (nginx, Netlify, Vercel, Cloudflare Pages, etc.)           │
│  - No server-side rendering                                  │
│  - No database queries                                       │
│  - CDN-friendly caching                                      │
└──────────────────────────────────────────────────────────────┘
```

---

## Technology Stack

### Build Tools
- **Astro 5.2:** Static site generator with zero JavaScript output
- **Vite:** Underlying bundler for development & production builds
- **TypeScript 5.7:** Type-safe code with strict mode

### Rendering Engines
- **React 19:** Component library (prerendered to static HTML)
- **JSX:** Component syntax (Astro files + React components)

### Styling
- **Tailwind CSS 3.4:** Utility-first CSS framework
- **Autoprefixer:** Vendor prefix handling
- **Custom CSS:** Scoped styles in Astro components

### Database Layer [Phase 1-2] - V1 Migration Ready

**Architecture:**
- **Drizzle ORM:** TypeScript-first ORM for PostgreSQL (type-safe queries)
- **PostgreSQL:** Backend database (V1 legacy schema with 57 tables)
- **Database Client:** postgres-js library (max 10 connections, pooling)
- **Elasticsearch:** Search engine for properties, projects, locations (Phase 4)

**V1 Schema Reference:**
- 57 active tables (core: real_estate, real_estate_transaction, project, consultation)
- 120+ foreign key relationships (hierarchical data patterns)
- Soft-delete pattern: `aactive=false` (never hard DELETE)
- Status enum fields: integer codes (1-5 range)
- Audit trail: `created_on`, `created_by`, `updated_on` (via triggers)
- Hierarchical data: self-referencing `parent_id` (locations, office, folders)

**Migration Path:**
- Phase 1-2: Menu system only (property_type, folder tables)
- Phase 3: Real estate schema (full property, project, news tables)
- Phase 4: Financial domain (commission, withdrawal, reconciliation)
- Phase 5: Office/staff system (post_office, office_staff hierarchy)

### Content & Assets
- **Mock Data:** TypeScript arrays in `src/data/` (fallback)
- **Database-Driven:** Menu structures from PostgreSQL (property types, news folders)
- **Icons:** Lucide via Iconify JSON
- **Images:** Static assets in `public/`
- **Fonts:** Inter (body), Be Vietnam Pro (headings)

### Integrations
- **@astrojs/react:** React component prerendering
- **@astrojs/tailwind:** Tailwind CSS integration
- **@astrojs/sitemap:** XML sitemap generation
- **@astrojs/check:** TypeScript validation

---

## Project Structure

### Directory Organization

```
src/
├── components/
│   ├── about/           # About page (team, achievements)
│   ├── auth/            # Authentication modal
│   ├── cards/           # Property card
│   ├── footer/          # Footer with nav & links
│   ├── header/          # Header & database-driven navigation
│   ├── home/            # Homepage sections (8: hero, projects, properties, locations, news, partners, press, download-app)
│   ├── news/            # News article components (share buttons, related articles)
│   ├── property/        # Property detail (gallery, info, contact, price chart, related)
│   ├── seo/             # JSON-LD structured data
│   ├── ui/              # Dropdowns (location with 63 provinces, property type), range sliders, checkbox, pagination, share buttons
│   └── scroll-to-top-button.astro
├── data/
│   ├── mock-properties.ts  # All mock data (properties, projects, news)
│   ├── menu-data.ts        # Build-time menu generation [Phase 2]
│   └── static-data.ts      # Static filter options (cities, types, prices) [Phase 3]
├── db/                     # [NEW] Database layer
│   ├── index.ts            # Drizzle ORM client initialization
│   ├── schema/             # Database schema definitions
│   │   ├── index.ts        # Schema exports
│   │   ├── menu.ts         # propertyType, folder tables
│   │   ├── real-estate.ts  # Property/listing schema
│   │   ├── project.ts      # Project schema
│   │   └── news.ts         # News schema
│   └── migrations/         # Database migrations
│       ├── 0000_*.sql      # Base schema
│       ├── 0001_*.sql      # Menu indexes
│       └── README-*.md     # Migration docs
├── services/               # [NEW] Business logic services
│   └── menu-service.ts     # Menu generation (property types, news folders)
├── layouts/
│   ├── base-layout.astro   # HTML <head>, meta tags, fonts
│   └── main-layout.astro   # Header + <main> + footer wrapper
├── pages/
│   ├── index.astro         # Homepage (SSR)
│   ├── gioi-thieu.astro    # About page (static)
│   ├── tin-tuc.astro       # News listing (static, 9 per page)
│   ├── tin-tuc/[slug].astro # News article detail (SSR)
│   ├── tin-tuc/trang/[page].astro # Paginated news (SSR)
│   ├── tin-tuc/danh-muc/[category].astro # Category filter (5)
│   ├── tin-tuc/danh-muc/[folder].astro # Dynamic folder pages (27)
│   └── bds/[slug].astro    # Property detail (SSR)
├── styles/
│   └── global.css          # Global Tailwind + custom styles
├── types/
│   ├── property.ts         # Property/Project/News interfaces
│   └── menu.ts             # Menu service types
└── utils/
    └── format.ts           # Formatting utilities (price, date, slug)

public/
├── favicon.svg
├── robots.txt
└── images/
    ├── hero-background.jpg
    ├── logo.svg
    └── ...

dist/                       # Build output (auto-generated)
├── index.html
├── sitemap.xml
├── styles/
└── images/
```

---

## Data Flow Architecture

### 1. Development Pipeline
```
TypeScript Code
    ↓
Astro Compiler
    ↓
React Prerender
    ↓
Tailwind CSS Processing
    ↓
Static HTML + CSS
```

### 2. Component Composition (Multi-Page)

**Homepage & Core Pages:**
```
pages/index.astro (Homepage, SSR)
├── layouts/main-layout.astro
│   ├── header (Database-driven nav from PostgreSQL)
│   ├── 8 homepage sections
│   ├── footer (Database-driven nav)
│   └── JSON-LD structured data

pages/gioi-thieu.astro (About, static)
├── Team member cards + achievement stats

pages/bds/[slug].astro (Property Detail, SSR)
├── Image gallery carousel
├── Property info section
├── Contact sidebar
├── Price history chart (Chart.js)
├── Featured project sidebar
├── Related properties

pages/tin-tuc.astro (News Listing, static)
├── Article cards
├── Pagination (9 per page)
├── Category filters

pages/tin-tuc/[slug].astro (News Article, SSR)
├── Article share buttons
├── Related articles sidebar
├── Author & date info

pages/tin-tuc/danh-muc/[folder].astro (Folder Pages, SSG)
├── 27 dynamic category pages auto-generated
├── News articles filtered by folder
├── Hierarchical navigation
```

**Database-Driven Menu Generation (Phase 4):**
```
Astro Build Process
  ├─ Folder Pages Generation (Phase 4)
  │   └─ /tin-tuc/danh-muc/[folder].astro
  │       ├─ Fetch all newsFolders via buildMenuStructure()
  │       ├─ Generate dynamic routes for each folder
  │       └─ Output: /dist/tin-tuc/danh-muc/{folder-name}/index.html (27 pages)
  │
  ├─ Navigation Menu Generation
  │   └─ header.astro
  │       └─ Calls getMainNavItems() from menu-data.ts
  │           └─ Calls buildMainNav() from menu-service.ts
  │               ├─ Check in-memory cache (1-hour TTL)
  │               ├─ If missing: buildMenuStructure()
  │               │   ├─ fetchPropertyTypesByTransaction(1,2,3)
  │               │   │   └─ Query: propertyType table (transaction_type)
  │               │   ├─ fetchNewsFolders()
  │               │   │   ├─ Query: folder table (parent=11, publish='T')
  │               │   │   └─ For each parent: fetchSubFolders(parentId)
  │               │   │       └─ Recursive: folder table (parent=parentId, publish='T')
  │               │   └─ Cache result (1 hour)
  │               └─ Transform to NavItem[] with nested children
  │                   ├─ folderToNavItem() recursively builds children
  │                   ├─ label: folder.label | folder.name
  │                   ├─ href: /tin-tuc/danh-muc/{folder.name}
  │                   └─ children?: NavItem[] (sub-folders)
  │       └─ Error handling: Return FALLBACK_MENU if DB unavailable
  │
  ├─ Filter Options (Phase 3)
  │   └─ hero-search.tsx uses static-data.ts
  │       ├─ cities[] (Hà Nội, TP.HCM, etc.)
  │       ├─ propertyTypes[] (Căn hộ, Nhà riêng, etc.)
  │       ├─ priceRanges[] (500M-1T, 1-2T, etc.)
  │       └─ areaRanges[] (<30m², 30-50m², etc.)
  │
  └─ Build outputs static HTML with embedded menu + 27 folder pages
     └─ No runtime database calls (data baked into HTML)
```

### 3. Data Source: Mock Data
```typescript
mock-properties.ts (single source of truth)
├── mockProperties: Property[]
├── mockProjects: Project[]
├── mockNews: NewsArticle[]
└── mockLocations: Location[]
     ↓ imported by ↓
  Section components → Rendered as HTML
```

### 4. Styling Pipeline
```
tailwind.config.mjs (define colors, fonts)
    ↓
global.css (@tailwind directives)
    ↓
Component styles (<style> blocks)
    ↓
Tailwind utility classes (inline in HTML)
    ↓
Final CSS bundle
```

---

## Component Architecture

### Astro Components (Server-Side)
Rendered at build time; output as static HTML.

```
property-card.astro
  Props: { property: Property }
  Output: <article> with price, image, title
  Logic: Format price, generate slug

hero-search.tsx (React wrapped in Astro)
  Props: { onSearch?: callback }
  Output: <form> with filters
  Logic: Handle user interaction (if client:load)

featured-project-section.astro
  Props: { projects: Project[] }
  Output: <section> grid of <ProjectCard>
  Logic: Filter featured projects, map cards
```

### React Components (Prerendered)
Rendered to static HTML during build; no JavaScript on page.

```
hero-search.tsx
  - Transaction type tabs (buy/rent/project)
  - City selector
  - Property type dropdown
  - Price range slider
  - Area range slider
  - Keyword input
  - Search button

header-mobile-menu.tsx
  - Mobile navigation toggle
  - Menu items
  - Close on navigation
```

### Layout Hierarchy
```
base-layout.astro
  └─ All pages use this
     - HTML doctype, <head> meta, fonts
     - Tailwind CSS injection
     - Analytics scripts (if any)

main-layout.astro
  └─ Wraps content pages
     - <header> (navigation)
     - <main> (page content slot)
     - <footer> (links, contact)
```

---

## Data Models & Type System

### Property Listing Model
```
Property {
  id: string                    // Unique identifier
  title: string                 // "Căn hộ cao cấp tại Hà Nội"
  slug: string                  // "can-ho-cao-cap-tai-ha-noi"
  type: PropertyType            // apartment | house | villa | ...
  transactionType: TransactionType  // sale | rent
  price: number                 // 5500 (if billion), 500 (if million)
  priceUnit: PriceUnit          // billion | million | per_month | VND
  area: number                  // 120 (m²)
  bedrooms?: number             // 3 (optional)
  bathrooms?: number            // 2 (optional)
  address: string               // "123 Phạm Văn Đồng"
  district: string              // "Cầu Giấy"
  city: string                  // "Hà Nội"
  description: string           // Long description
  images: string[]              // [url1, url2, ...]
  thumbnail: string             // Primary image URL
  features: string[]            // ["Có ban công", "Tầng cao"]
  createdAt: string             // ISO date
  isFeatured: boolean           // Show in featured section
  isHot: boolean                // Show hot badge
}
```

### Project Model
```
Project {
  id: string
  name: string                  // Project name
  slug: string
  developer: string             // Developer company
  location: string              // "Quận 7, TP.HCM"
  city: string
  status: ProjectStatus         // upcoming | selling | sold_out | completed
  totalUnits: number            // 500 units
  priceRange: string            // "5.5 tỷ - 10 tỷ"
  area: string                  // "50 - 150 m²"
  description: string
  images: string[]
  thumbnail: string
  amenities: string[]           // ["Gym", "Pool", "Parking"]
  completionDate?: string       // ISO date
  isFeatured: boolean
}
```

### News/Article Model
```
NewsArticle {
  id: string
  title: string
  slug: string
  excerpt: string               // Preview text
  content: string               // Full article (markdown or HTML)
  thumbnail: string
  category: NewsCategory        // market | policy | tips | project_news | investment
  author: string                // "Bộ phận Quản lý Nội dung"
  publishedAt: string           // ISO date
  views: number                 // Article view count
}
```

### Search Filters Model
```
SearchFilters {
  transactionType: TransactionType  // Required: sale | rent
  city?: string                     // "ha-noi"
  keyword?: string                  // Free text search
  propertyType?: PropertyType       // apartment | house | ...
  priceMin?: number                 // Minimum price
  priceMax?: number                 // Maximum price
  areaMin?: number                  // Minimum area m²
  areaMax?: number                  // Maximum area m²
}
```

---

## Build & Deployment Flow

### Development
```
npm run dev
  └─ Starts Astro dev server on http://localhost:3000
     - Hot reload on file changes
     - In-memory builds (fast iteration)
     - Full TypeScript checking
```

### Production Build
```
npm run build
  ├─ Environment: Load DATABASE_URL from .env (Phase 2)
  ├─ Step 1: astro check
  │   └─ TypeScript validation (strict mode)
  ├─ Step 2: astro build
  │   ├─ Menu Generation (Phase 2)
  │   │   ├─ menu-data.ts: getMainNavItems() executes
  │   │   │   ├─ Fetch from database via menu-service.ts
  │   │   │   ├─ Fallback to FALLBACK_MENU if unavailable
  │   │   │   └─ Embed result in static HTML
  │   │   └─ Logs: menu item count, fetch duration, errors
  │   ├─ Scan src/pages → generate routes
  │   ├─ Render Astro components to HTML
  │   ├─ Prerender React components
  │   ├─ Process Tailwind CSS
  │   └─ Bundle assets
  └─ Output: dist/ directory
     ├─ index.html (homepage with embedded menu)
     ├─ sitemap.xml
     ├─ _astro/ (CSS, JS chunks)
     └─ images/
```

### Output Characteristics
- **Zero JavaScript:** All interactive React components prerendered
- **Static HTML:** Served by any static file server
- **SEO Optimized:** Sitemap, meta tags, structured data ready
- **Cache Friendly:** Content hashing for long-term caching
- **Performance:** <2 second load time (depends on hosting)

### Deployment Options
- **Netlify:** `netlify deploy --prod`
- **Vercel:** Connect GitHub repo for auto-deploy
- **Cloudflare Pages:** Upload dist/ folder or connect Git
- **Self-hosted:** Copy dist/ to web server (nginx, Apache)

---

## Vietnamese Localization Architecture

### Formatting Utilities (format.ts)
```
formatPrice()         → "5.5 tỷ", "500 triệu", "15 triệu/tháng"
formatNumber()        → "1.500.000" (Vietnamese thousand sep)
formatDate()          → "28 tháng 1 năm 2026"
formatRelativeTime()  → "2 ngày trước", "Hôm qua"
generateSlug()        → "dấu-tiếng-việt" → "dau-tieng-viet"
truncateText()        → Ellipsis for long text
```

### Content Data (header-nav-data.ts)
```
mainNavItems[]   → Navigation menu in Vietnamese
cities[]         → Hà Nội, TP.HCM, Đà Nẵng, etc.
propertyTypes[]  → Căn hộ, Nhà riêng, Biệt thự, etc.
priceRanges[]    → Dưới 500 triệu, 500M - 1T, etc.
areaRanges[]     → < 30m², 30-50m², 50-80m², etc.
```

### Language Considerations
- All UI text in Vietnamese
- Vietnamese character handling in slugs
- Regional number/currency formatting
- Date format: day tháng month năm year

---

## Performance Considerations

### Optimization Strategies
1. **Static Generation:** Eliminate runtime overhead
2. **CSS Optimization:** Tailwind purges unused styles
3. **Image Optimization:** Next-gen formats (WebP), lazy loading
4. **Code Splitting:** Automatic by Astro build system
5. **Caching:** Long-term caching via content hashing

### Metrics
| Metric | Target |
|---|---|
| Lighthouse Performance | >90 |
| First Contentful Paint | <1 second |
| Cumulative Layout Shift | <0.1 |
| Time to Interactive | <1 second |
| Total Bundle Size | <3 MB |

---

## Security Architecture

### Client-Side Security
- No sensitive data in client-side code
- No API keys in frontend
- No user authentication logic exposed
- Future: CSP headers, X-Frame-Options

### Server-Side (None)
- Static output only; no server-side logic
- Future backend: API layer separate from frontend

### Data Privacy
- No tracking scripts (no Google Analytics)
- Future: Privacy policy, GDPR compliance
- No user registration/login (yet)

---

## Scalability & Future Evolution

### Phase 1 (Current): Static Frontend
- Single index.html homepage
- Mock data only
- Static deployment

### Phase 2: Dynamic Pages
- Property detail pages (dynamic routes)
- Project detail pages
- Article pages
- SEO per page (meta tags, Open Graph)

### Phase 3: Backend Integration
- API layer (REST or GraphQL)
- Real property database
- CMS for articles
- Authentication/authorization

### Phase 4: Advanced Features
- Real-time property updates
- Map integration (Google Maps)
- Image gallery (lightbox)
- Lead generation forms

---

## Monitoring & Observability

### Current
- Manual testing
- TypeScript compilation checks
- Browser dev tools

### Planned
- Sentry (error tracking)
- Analytics (property views, search patterns)
- Performance monitoring
- SEO rank tracking

---

## Referenced Documentation

See legacy V1 architecture details in separate files:
- [V1 Database Schema Reference](./v1-database-schema.md) - 57 tables, 120+ relationships
- [V1 Elasticsearch Schema Reference](./v1-elasticsearch-schema.md) - 3 indexes, search patterns
- [V1 Data Flow & Synchronization](./v1-data-flow.md) - Real-time sync, batch processing

---

## Phase 4: Hierarchical News Folder Support [NEW]

### Hierarchical Menu Architecture
```
Frontend (Header/Nav + Folder Pages)
    ↓
Astro Build Time
    ↓
menu-service.ts
├─ buildMenuStructure()      # Main entry point with caching
│   ├─ Cache check (1-hour TTL)
│   ├─ fetchPropertyTypesByTransaction(1,2,3)  # Query property types by transaction
│   ├─ fetchNewsFolders()        # Query parent folders + sub-folders recursively
│   │   ├─ SELECT folders WHERE parent=11 AND publish='T' (parent folders)
│   │   └─ FOR EACH parent: fetchSubFolders(parentId)
│   │       └─ Recursive: SELECT folders WHERE parent=parentId AND publish='T'
│   └─ Parallel data fetching with Promise.all()
├─ folderToNavItem()         # Recursively transform MenuFolder → NavItem
│   ├─ Map folder.name to slug
│   ├─ Generate href: /tin-tuc/danh-muc/{slug}
│   └─ Recursively map subFolders[] to children[]
└─ buildMainNav()            # Generate NavItem[] with nested children
    ↓
[folder].astro Dynamic Page Generation (Phase 4)
├─ Get all newsFolders via buildMenuStructure()
├─ Generate static paths for each folder
├─ Render: /tin-tuc/danh-muc/{folder-name}/
└─ Output: 27 static HTML files
    ↓
Static HTML Generation (Astro output)
    ↓
Browser (No runtime database calls)
```

### Data Structure: MenuFolder Hierarchy
```typescript
interface MenuFolder {
  id: number;
  parent: number | null;
  name: string | null;
  label: string | null;
  publish: string; // 'T' = published
  displayOrder: number | null;
  subFolders?: MenuFolder[];  // Recursive children [Phase 4]
}
```

Example tree:
```
Tin Tức (parent=11)
├── Bất Động Sản
│   ├── Thị Trường
│   └── Pháp Lý
├── Dự Án
└── Khác
```

### Database Schema Files
- **src/db/schema/menu.ts:** propertyType, folder table schemas
- **src/db/migrations/0001_add_menu_indexes.sql:** Performance indexes on transaction_type, parent, display_order

### Service Implementation Details
- **Cache Layer:** In-memory Map with configurable TTL (default 1 hour)
- **Error Handling:** Graceful fallback to static menu if DB unavailable
- **Type Safety:** MenuPropertyType, MenuFolder, MenuStructure interfaces
- **Logging:** Debug logs for cache hits/misses, data fetching

### Performance Optimization
- In-memory caching eliminates repeated DB queries during build
- Parallel Promise.all() for property types + news folders
- Indexes on propertyType.transaction_type, folder.parent, folder.display_order
- No runtime database calls (data resolved at build time)

## Referenced Documentation

See detailed V1 schema documentation for deeper analysis:
- [V1 Database Schema Reference](./v1-database-schema.md) - 57 tables, 120+ relationships
- [V1 Elasticsearch Schema Reference](./v1-elasticsearch-schema.md) - 3 indexes, search patterns
- [V1 Data Flow & Synchronization](./v1-data-flow.md) - Real-time sync, batch processing

---

## Document History

| Version | Date | Changes |
|---|---|---|
| 3.0 | 2026-02-07 | Scout: 32 components across 10 categories (about, auth, news, property, seo, ui, home), 8 page routes (index, about, news listing, article detail, property detail, category filters, 27 folder pages), multi-page component composition patterns, service layers (elasticsearch, postgres, menu) |
| 2.4 | 2026-02-06 | Phase 4: Hierarchical news folders, 27 dynamic folder pages, recursive transformation patterns |
| 2.3 | 2026-02-06 | Phase 3: static-data.ts module, separated concerns (mock vs menu vs static data) |
| 2.2 | 2026-02-06 | Phase 2: Build-time menu generation, environment loading, fallback strategy |
| 2.1 | 2026-02-06 | Phase 1: Menu service, Drizzle ORM, caching with 1-hour TTL |
| 2.0 | 2026-02-06 | V1 legacy architecture reference, migration path |
| 1.0 | 2026-01-28 | Initial documentation |
